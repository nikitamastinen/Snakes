<!DOCTYPE html>
<html lang="en-US">
  <head>
  	<title>Snake Game</title>
  </head>

  <body>

    <div id="score">0</div>
    <canvas id="snakeboard" width="400" height="400"></canvas>

    <style>
      #snakeboard {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
  </body>

  <script>
    const client_id = Date.now()
    const socket = new WebSocket(`ws://93.175.2.219:80/ws/${client_id}`);
    function waitForSocketConnection() {
      const timer = setTimeout(
        function () {
          if (socket.readyState === 1) {
            console.log("kek");
            run();
            clearTimeout(timer);
          } else {
            waitForSocketConnection();
          }
        }, 5
      );
    }
    waitForSocketConnection();
    function run() {
      const board_border = 'black';
      const board_background = "white";
      //const snake_col = 'lightblue';
      var colors = ['#0000FF', '#27e024', '#b6d11f', '#2485bd', '#bd9e24', '#ae24bd'];
      const snake_col = colors[client_id % colors.length];
      const snake_border = 'darkblue';

      const SNAKES = {};
      let snake = [{x: 200, y: 200}];
      socket.send(`add ${200} ${200} ${client_id}`);

      let score = 0;
      let changing_direction = false;
      let food = [];
      let food_x;
      let food_y;
      let dx = 10;
      let dy = 0;


      const snakeboard = document.getElementById("snakeboard");
      const snakeboard_ctx = snakeboard.getContext("2d");
      socket.addEventListener('message', function (event) {
        const coords = event.data.split(' ');
        if (coords[0] === "delete") {
          delete SNAKES[coords[1]];
        } else if (parseInt(coords[3]) !== client_id) {
          if (SNAKES[coords[3]] == null) {
            SNAKES[coords[3]] = [];
          }
          if (coords[0] === "popadd") {
            SNAKES[coords[3]].unshift({x: parseInt(coords[1]), y: parseInt(coords[2])});
            SNAKES[coords[3]].pop();
          } else if (coords[0] === "food") {
            food.unshift({x: parseInt(coords[1]), y: parseInt(coords[2])});
          } else if (coords[0] === "popfood") {
            var index = -1;
            for (let i = 0; i < food.length; i++) {
              if (parseInt(coords[1]) === food[i].x && parseInt(coords[2]) === food[i].y) {
                index = i;
                break;
              }
            }
            if (index > -1) {
              food.splice(index, 1);
            }
            console.log("DEBUG" + client_id + ' ' + index + ' ' + parseInt(coords[1]) + ' ' + parseInt(coords[2]));
          } else if (coords[0] === "add") {
             SNAKES[coords[3]].unshift({x: parseInt(coords[1]), y: parseInt(coords[2])});
          } else {
            SNAKES[coords[3]].pop();
          }
        }
      });

      main();
      document.addEventListener("keydown", change_direction);

      function main() {
        if (has_game_ended()) return;

        changing_direction = false;
        setTimeout(function onTick() {
          clear_board();
          drawFoodOnline();
          move_snake();
          drawSnake();
          main();
        }, 120)
      }

      function clear_board() {
        snakeboard_ctx.fillStyle = board_background;
        snakeboard_ctx.strokestyle = board_border;
        snakeboard_ctx.fillRect(0, 0, snakeboard.width, snakeboard.height);
        snakeboard_ctx.strokeRect(0, 0, snakeboard.width, snakeboard.height);
      }

      function drawSnake() {
        for (let i = 0; i < snake.length; i++) {
          drawSnakePart(snake[i], snake_col);
        }
        snakeboard_ctx.font = "8px arial";
        snakeboard_ctx.fillStyle = "grey";
        snakeboard_ctx.fillText(client_id.toString(), snake[0].x, snake[0].y - 3);

        for (const key in SNAKES) {
          const p = SNAKES[key];
          if (p === null || p.length === 0) continue;
          snakeboard_ctx.font = "8px arial";
          snakeboard_ctx.fillStyle = "grey";
          snakeboard_ctx.fillText(key, p[0].x, p[0].y - 3);
          for (let i = 0; i < p.length; i++) {
            drawSnakePart(p[i], colors[parseInt(key) % colors.length]);
          }
        }
      }

      function drawFoodOnline() {
        snakeboard_ctx.fillStyle = 'lightgreen';
        //snakeboard_ctx.strokeStyle = 'darkgreen';
        for (let i = 0; i < food.length; i++) {
          snakeboard_ctx.fillRect(food[i].x - 10, food[i].y - 10, 10, 10);
          snakeboard_ctx.strokeRect(food[i].x - 10, food[i].y - 10, 10, 10);
        }
      }

      function drawSnakePart(snakePart, col) {
        snakeboard_ctx.fillStyle = col;
        snakeboard_ctx.strokestyle = snake_border;
        snakeboard_ctx.fillRect(snakePart.x - 10, snakePart.y - 10, 10, 10);
        snakeboard_ctx.strokeRect(snakePart.x - 10, snakePart.y - 10, 10, 10);
      }

      function has_game_ended() {
        for (let i = 4; i < snake.length; i++) {
          if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) {
            socket.send(`delete ${client_id}`)
            // for (let i = 0; i < snake.length; i++) {
            //   socket.send(`pop ${snake[i].x} ${snake[i].y} ${client_id}`);
            // }
            return true;
          }
        }
        const hitLeftWall = snake[0].x < 10;
        const hitRightWall = snake[0].x > snakeboard.width;
        const hitToptWall = snake[0].y < 10;
        const hitBottomWall = snake[0].y > snakeboard.height;
        if (hitLeftWall || hitRightWall || hitToptWall || hitBottomWall) {
          socket.send(`delete ${client_id}`)
          return true;
        }
        return false;
      }

      function change_direction(event) {
        const LEFT_KEY = 37;
        const RIGHT_KEY = 39;
        const UP_KEY = 38;
        const DOWN_KEY = 40;
        if (changing_direction) {
          return;
        }
        changing_direction = true;
        const keyPressed = event.keyCode;
        const goingUp = dy === -10;
        const goingDown = dy === 10;
        const goingRight = dx === 10;
        const goingLeft = dx === -10;
        if (keyPressed === LEFT_KEY && !goingRight) {
          dx = -10;
          dy = 0;
        }
        if (keyPressed === UP_KEY && !goingDown) {
          dx = 0;
          dy = -10;
        }
        if (keyPressed === RIGHT_KEY && !goingLeft) {
          dx = 10;
          dy = 0;
        }
        if (keyPressed === DOWN_KEY && !goingUp) {
          dx = 0;
          dy = 10;
        }
      }

      function move_snake() {
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};
        snake.unshift(head);
        var isFoodLeft = false;
        var indexx = -1;
        for (let i = 0; i < food.length; i++) {
          if (snake[0].x === food[i].x && snake[0].y === food[i].y) {
            isFoodLeft = true;
            indexx = i;
            break;
          }
        }
        if (isFoodLeft) {
          socket.send(`popfood ${snake[0].x} ${snake[0].y}`);
          food.splice(indexx, 1);
          socket.send(`add ${head.x} ${head.y} ${client_id}`);
          score += 10;
          document.getElementById('score').innerHTML = score;
        } else {
          const last = snake.pop();
          socket.send(`popadd ${head.x} ${head.y} ${client_id} ${last.x} ${last.y}`);
        }
      }
    }
  </script>
</html>